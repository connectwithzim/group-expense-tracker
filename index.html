<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Expense Tracker</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
  :root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --sub:#64748b; --muted:#e2e8f0; --brand:#6d28d9; --danger:#ef4444; --success:#22c55e; }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--ink)}
  .container{max-width:1100px;margin:28px auto;padding:0 16px}
  .app{background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:22px}
  .title{font-weight:800;text-align:center;margin:4px 0 16px;font-size:26px;color:#5b21b6}
  
  /* Login Screen Styles */
  #login-screen { max-width: 320px; margin: 40px auto; text-align: center; }
  #login-screen select, #login-screen input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--muted); font-size: 16px; }
  #login-screen input { text-align: center; letter-spacing: 5px; font-weight: bold; }
  
  /* App Styles */
  .tabs{display:flex;gap:8px;justify-content:center;margin:8px 0 18px}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--muted);background:#fff;cursor:pointer;font-weight:600}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--muted);border-radius:12px;padding:16px}
  .card h3{margin:0 0 10px;font-size:16px}
  .row{display:flex;gap:10px;margin-bottom:10px}
  
  /* Inputs & Buttons */
  input,select,button{width:100%;border:1px solid var(--muted);border-radius:10px;padding:12px;font:inherit;font-size:15px;}
  button.primary{background:var(--brand);color:#fff;border-color:transparent;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:none;color:var(--sub);cursor:pointer}
  
  /* Split Between Pills - BIGGER NOW */
  .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{
      padding:12px 16px; 
      border-radius:10px;
      border:1px solid var(--muted);
      cursor:pointer;
      background:#f8fafc;
      width:auto;
      font-weight: 500;
      flex: 1 1 20%; 
      text-align: center;
      min-width: 80px;
  }
  .pill.active{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.4);color:#065f46;font-weight:700}

  /* Tables & Lists */
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th{font-size:12px;color:var(--sub);text-align:left;padding:6px}
  td{background:#fff;border:1px solid var(--muted);padding:10px 8px;font-size:14px}
  .right{text-align:right}
  
  /* History Badges */
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .badge.expense{ background:rgba(239,68,68,.12); color:#b91c1c; border:1px solid rgba(239,68,68,.35); }
  .badge.payment{ background:rgba(34,197,94,.12); color:#065f46; border:1px solid rgba(34,197,94,.35); }
  .badge.danger { background: #ef4444; color: white; border:none; cursor: pointer; }

  /* Balances & Totals */
  #balances, #totals { display:grid; gap:10px; }
  .mini{border:1px solid var(--muted);border-radius:12px;padding:12px;box-shadow:0 4px 6px rgba(0,0,0,0.02);}
  .mini h4{margin:0 0 8px;font-size:16px;color:var(--brand)}
  .line{display:flex;justify-content:space-between;padding:4px 0;font-size:14px}
  .amt-pos{color:#22c55e;font-weight:700} .amt-neg{color:#ef4444;font-weight:700}
  
  /* Totals styling */
  .rowline { display:flex; justify-content:space-between; align-items:center; gap:12px; font-size:13px; margin-bottom:4px; }
  .rowline b { min-width:8ch; text-align:right; }
  
  /* Weeks Coloring */
  .mini .rowline:nth-of-type(1) span{color:#ef4444;} .mini .rowline:nth-of-type(2) span{color:#f59e0b;} 
  .mini .rowline:nth-of-type(3) span{color:#10b981;} .mini .rowline:nth-of-type(4) span{color:#3b82f6;} 
  .mini .rowline:nth-of-type(5) span{color:#6d28d9;} .mini .rowline:nth-of-type(6) span{color:#0ea5e9;} 
  .mini .rowline:nth-of-type(7) span{color:#64748b;}
  </style>
</head>
<body>
  <div class="container">
    <div class="app">
      <div class="title">Group Expense Tracker</div>

      <div id="login-screen">
        <p style="color:var(--sub);margin-bottom:20px;">Select your name and enter your PIN</p>
        <select id="loginName">
          <option value="tayyab">Tayyab</option>
          <option value="islam">Islam</option>
          <option value="mahmur">Mahmur</option>
          <option value="guest">Guest</option>
        </select>
        <input id="loginPin" type="tel" maxlength="6" placeholder="******" />
        <button id="loginBtn" class="primary">Unlock App</button>
        <p id="loginError" style="color:red;font-size:13px;display:none;margin-top:10px;"></p>
      </div>

      <div id="main-app" style="display:none">
        <div style="text-align:center;margin-bottom:15px;">
           <span id="user-greeting" style="font-weight:bold;color:var(--brand)"></span>
           <button id="logoutBtn" style="width:auto;padding:4px 12px;font-size:12px;margin-left:10px;" class="ghost">Lock App üîí</button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="add">üí∏ Add Expense</button>
          <button class="tab" data-tab="pay">ü§ù Pay Back</button>
          <button class="tab" data-tab="history">üìú History</button>
        </div>

        <div id="tab-add" class="tabview">
          <div class="grid">
            <div class="card">
              <h3>Add Expense</h3>
              <div class="row"><input id="amount" type="number" step="0.01" placeholder="Amount"/></div>
              <div class="row"><select id="paidBy"></select></div>
              <div class="row"><input id="desc" placeholder="Description"/></div>
              <div style="font-size:12px;color:var(--sub);margin-bottom:4px;font-weight:600;">Split Between (Tap to select):</div>
              <div id="splitBetween" class="pillbar"></div>
              <div class="row"><button id="addBtn" class="primary">Add Expense</button></div>
            </div>
            <div class="card"><h3>Balances</h3><div id="balances"></div></div>
          </div>
        </div>

        <div id="tab-pay" class="tabview" style="display:none">
          <div class="grid">
            <div class="card">
              <h3>Record Payment</h3>
              <div class="row"><input id="payAmount" type="number" step="0.01" placeholder="Amount"/></div>
              <div class="row"><select id="from"></select></div>
              <div class="row"><select id="to"></select></div>
              <div class="row"><button id="payBtn" class="primary">Record Payment</button></div>
            </div>
            <div class="card"><h3>Totals by Person</h3><div id="totals"></div></div>
          </div>
        </div>

        <div id="tab-history" class="tabview" style="display:none">
          <div class="card">
            <h3>History</h3>
            <div style="overflow-x:auto"><table id="historyTable"><thead><tr><th>Date</th><th>Type</th><th class="right">Amt</th><th>Details</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

  // CONFIGURATION
  const firebaseConfig = {
    apiKey: "AIzaSyDwP_AusU7Rar2aguy0DVGGlravF9q2D1g",
    authDomain: "house-expenditure-calculator.firebaseapp.com",
    projectId: "house-expenditure-calculator",
    storageBucket: "house-expenditure-calculator.firebasestorage.app",
    messagingSenderId: "209030650549",
    appId: "1:209030650549:web:de2eae21574b9023f1bcfc",
    measurementId: "G-0HV7FPY7ME"
  };

  const PEOPLE = ['Tayyab','Islam','Mahmur','Guest'];
  const CURRENCY = '‚Ç∫';

  // INIT
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const txCol = collection(db, 'transactions');
  
  const $ = s => document.querySelector(s);
  const el = (t,c,h)=>{const e=document.createElement(t);if(c)e.className=c;if(h)e.innerHTML=h;return e};

  // --- AUTHENTICATION LOGIC ---
  const loginBtn = $('#loginBtn');
  const errorMsg = $('#loginError');

  // Use addEventListener for safety
  if(loginBtn) {
    loginBtn.addEventListener('click', () => {
      const name = $('#loginName').value;
      const pin = $('#loginPin').value;
      const email = `${name}@group.app`; 
      
      // UI Feedback: Show user something is happening
      loginBtn.textContent = "Unlocking...";
      loginBtn.disabled = true;
      errorMsg.style.display = 'none';

      signInWithEmailAndPassword(auth, email, pin)
        .catch(e => {
          // ERROR HANDLER: Reset button and show error
          loginBtn.textContent = "Unlock App";
          loginBtn.disabled = false;
          errorMsg.style.display = 'block';
          
          // Friendly Error Messages
          if(e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password') {
            errorMsg.textContent = "Wrong PIN! Please try again.";
            alert("Wrong PIN! Please try again.");
          } else if (e.code === 'auth/user-not-found') {
             errorMsg.textContent = "User not found. Did you create this user in Firebase Console?";
             alert("Error: User not found in Firebase. Check 'Authentication' tab in Firebase Console.");
          } else {
             errorMsg.textContent = "Error: " + e.message;
             alert("Error: " + e.message);
          }
          console.error(e);
        });
    });
  }

  $('#logoutBtn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      $('#login-screen').style.display = 'none';
      $('#main-app').style.display = 'block';
      const name = user.email.split('@')[0];
      $('#user-greeting').textContent = `Hi, ${name.charAt(0).toUpperCase() + name.slice(1)}`;
      $('#loginPin').value = ''; 
      if(loginBtn) { loginBtn.textContent = "Unlock App"; loginBtn.disabled = false; } // Reset button
      startApp(); 
    } else {
      $('#login-screen').style.display = 'block';
      $('#main-app').style.display = 'none';
      $('#historyTable tbody').innerHTML = ''; 
      $('#balances').innerHTML = '';
      if(unsubscribe) unsubscribe();
    }
  });

  // --- APP LOGIC ---

  let unsubscribe;

  function startApp() {
    $('#paidBy').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    $('#from').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    $('#to').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    
    $('#splitBetween').innerHTML = '';
    PEOPLE.forEach(p => {
       const b = el('button','pill',p);
       b.onclick = ()=>b.classList.toggle('active');
       $('#splitBetween').appendChild(b);
    });

    if(unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(query(txCol, orderBy('createdAt','desc')), (snap) => {
      const txs = [];
      snap.forEach(d => txs.push({id:d.id, ...d.data()}));
      renderHistory(txs);
      calculateBalances(txs);
      calculateTotals(txs); 
    }, (err) => {
      // If data fetch fails (e.g. permission rules)
      console.error(err);
      alert("Login successful, but cannot read data. Check your Firestore Security Rules.");
    });
  }

  // Add Expense
  $('#addBtn').onclick = async () => {
    const amt = parseFloat($('#amount').value);
    const who = $('#paidBy').value;
    const desc = $('#desc').value;
    const split = Array.from(document.querySelectorAll('#splitBetween .pill.active')).map(b=>b.textContent);
    
    if(!amt || !who || split.length===0) return alert('Fill amount, payer and split');
    
    try {
      await addDoc(txCol, {type:'Expense', amount:amt, paidBy:who, splitBetween:split, description:desc, date:new Date().toISOString(), createdAt:serverTimestamp()});
      $('#amount').value=''; $('#desc').value=''; 
      document.querySelectorAll('.pill.active').forEach(b=>b.classList.remove('active'));
    } catch(e) { alert('Permission Denied: ' + e.message); }
  };

  // Add Payment
  $('#payBtn').onclick = async () => {
    const amt = parseFloat($('#payAmount').value);
    const f = $('#from').value; const t = $('#to').value;
    if(!amt || f===t) return alert('Check details');
    try {
      await addDoc(txCol, {type:'Payment', amount:amt, from:f, to:t, date:new Date().toISOString(), createdAt:serverTimestamp()});
      $('#payAmount').value='';
    } catch(e) { alert('Permission Denied: ' + e.message); }
  };

  // Render History
  function renderHistory(txs) {
    const tbody = $('#historyTable tbody'); tbody.innerHTML = '';
    tbody.onclick = async (e) => {
       if(e.target.classList.contains('danger')) {
         if(confirm('Delete?')) {
            try { await deleteDoc(doc(db,'transactions',e.target.dataset.id)); }
            catch(err){ alert('Permission Denied'); }
         }
       }
    };
    txs.forEach(t => {
       const d = t.date ? t.date.slice(0,10) : '';
       const isExp = t.type === 'Expense';
       const badge = isExp 
        ? '<span class="badge expense">Expense</span>' 
        : '<span class="badge payment">Payment</span>';
       const desc = t.description || (isExp ? 'Expense' : 'Payment');
       
       const who = isExp 
         ? `${t.paidBy}<br><span style="font-size:11px;color:#64748b">Split: ${(t.splitBetween||[]).join(', ')}</span>`
         : `${t.from} ‚Üí ${t.to}`;

       const tr = el('tr','',`
         <td>${d}</td>
         <td>${badge}<br><span style="font-size:12px">${desc}</span></td>
         <td class="right" style="font-weight:bold">${CURRENCY}${t.amount}</td>
         <td>${who}</td>
         <td><button class="badge danger" data-id="${t.id}">X</button></td>
       `);
       tbody.appendChild(tr);
    });
  }

  // Calculate Balances 
  function calculateBalances(txs) {
     const idx = Object.fromEntries(PEOPLE.map((p,i)=>[p,i]));
     const owes = Array.from({length:4},()=>Array(4).fill(0));
     txs.slice().reverse().forEach(t => {
        if(t.type==='Expense') {
           const inc = (t.splitBetween||[]).filter(x=>PEOPLE.includes(x));
           if(!inc.length) return;
           const payerI = idx[t.paidBy];
           const share = t.amount / inc.length;
           inc.forEach(name => {
              const owerI = idx[name];
              if(owerI !== payerI) owes[owerI][payerI] += share;
           });
        } else { 
           const f = idx[t.from], to = idx[t.to];
           if(f!=null && to!=null) owes[f][to] -= t.amount;
        }
     });

     const box = $('#balances'); box.innerHTML = '';
     PEOPLE.forEach((p, i) => {
        const card = el('div','mini',`<h4>${p}</h4>`);
        PEOPLE.forEach((other, j) => {
           if(i===j) return;
           const net = owes[i][j] - owes[j][i];
           if(Math.abs(net) > 0.1) {
              const color = net > 0 ? 'amt-neg' : 'amt-pos';
              const text = net > 0 ? `Owes ${other}` : `${other} owes me`;
              card.appendChild(el('div','line',`${text} <span class="${color}">${CURRENCY}${Math.abs(net).toFixed(2)}</span>`));
           }
        });
        box.appendChild(card);
     });
  }

  // Calculate Totals (Weeks, Months)
  function calculateTotals(txs) {
    const byPerson = Object.fromEntries(PEOPLE.map(p => [p, { w1:0, w2:0, w3:0, w4:0, month:0, lastMonth:0, prev2Month:0 }]));
    
    const today = new Date();
    const y = today.getFullYear(), m = today.getMonth();
    const startThisMonth = new Date(y, m, 1);
    const startNextMonth = new Date(y, m + 1, 1);
    const startLastMonth = new Date(y, m - 1, 1);
    const startPrev2Month = new Date(y, m - 2, 1);

    const weekOfMonth = (d) => { const day = d.getDate(); return day <= 7 ? 1 : day <= 14 ? 2 : day <= 21 ? 3 : 4; };

    txs.forEach(t => {
      if (t.type !== 'Expense') return;
      const when = new Date(t.date || Date.now());
      const amt = Number(t.amount) || 0;
      const inc = (t.splitBetween||[]).filter(n => PEOPLE.includes(n));
      
      if (inc.length === 0 || !isFinite(amt) || amt <= 0) return;
      
      const share = amt / inc.length;
      
      inc.forEach(name => {
        if (when >= startThisMonth && when < startNextMonth) {
          const w = weekOfMonth(when);
          byPerson[name][`w${w}`] += share;
          byPerson[name].month += share;
        }
        if (when >= startLastMonth && when < startThisMonth) {
          byPerson[name].lastMonth += share;
        }
        if (when >= startPrev2Month && when < startLastMonth) {
          byPerson[name].prev2Month += share;
        }
      });
    });

    const totals = $('#totals'); totals.innerHTML = '';
    PEOPLE.forEach(p => {
      const d = byPerson[p];
      const card = el('div','mini');
      card.innerHTML = `
        <h4>${p}</h4>
        <div class="rowline"><span>1st week:</span><b>${CURRENCY}${d.w1.toFixed(2)}</b></div>
        <div class="rowline"><span>2nd week:</span><b>${CURRENCY}${d.w2.toFixed(2)}</b></div>
        <div class="rowline"><span>3rd week:</span><b>${CURRENCY}${d.w3.toFixed(2)}</b></div>
        <div class="rowline"><span>4th week:</span><b>${CURRENCY}${d.w4.toFixed(2)}</b></div>
        <div class="rowline"><span>This month:</span><b>${CURRENCY}${d.month.toFixed(2)}</b></div>
        <div class="rowline"><span>Last Month:</span><b>${CURRENCY}${d.lastMonth.toFixed(2)}</b></div>
        <div class="rowline"><span>2nd Last Month:</span><b>${CURRENCY}${d.prev2Month.toFixed(2)}</b></div>
      `;
      totals.appendChild(card);
    });
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(b => b.onclick = () => {
     document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
     b.classList.add('active');
     document.querySelectorAll('.tabview').forEach(v=>v.style.display='none');
     $('#tab-'+b.dataset.tab).style.display='block';
  });

</script>
</body>
</html>
