<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Group Expense Tracker</title>
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png?v=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
  :root{ --bg:#f6f7fb; --card:#ffffff; --ink:#0f172a; --sub:#64748b; --muted:#e2e8f0; --brand:#6d28d9; --danger:#ef4444; }
  *{box-sizing:border-box}
  html,body{height:100%;}
  body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--ink)}
  .container{max-width:1100px;margin:28px auto;padding:0 16px}
  .app{background:var(--card);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.06);padding:22px}
  .title{font-weight:800;text-align:center;margin:4px 0 16px;font-size:26px;color:#5b21b6}
  
  /* Login Screen Styles */
  #login-screen { max-width: 320px; margin: 40px auto; text-align: center; }
  #login-screen select, #login-screen input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid var(--muted); font-size: 16px; }
  #login-screen input { text-align: center; letter-spacing: 5px; font-weight: bold; }
  
  /* App Styles */
  .tabs{display:flex;gap:8px;justify-content:center;margin:8px 0 18px}
  .tab{padding:10px 14px;border-radius:999px;border:1px solid var(--muted);background:#fff;cursor:pointer;font-weight:600}
  .tab.active{background:var(--brand);color:#fff;border-color:transparent}
  .grid{display:grid;grid-template-columns:1fr;gap:16px}
  .card{background:#fff;border:1px solid var(--muted);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;margin-bottom:10px}
  input,select,button{width:100%;border:1px solid var(--muted);border-radius:10px;padding:10px 12px;font:inherit}
  button.primary{background:var(--brand);color:#fff;border-color:transparent;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:none;color:var(--sub);cursor:pointer}
  
  .pillbar{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .pill{padding:8px 12px;border-radius:999px;border:1px solid var(--muted);cursor:pointer;background:#f8fafc;width:auto;}
  .pill.active{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.4);color:#065f46}

  /* Tables & Lists */
  table{width:100%;border-collapse:separate;border-spacing:0 6px}
  th{font-size:12px;color:var(--sub);text-align:left;padding:6px}
  td{background:#fff;border:1px solid var(--muted);padding:10px 8px;font-size:14px}
  .right{text-align:right}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:700}
  .expense{background:rgba(14,165,233,.12);color:#075985}
  .payment{background:rgba(34,197,94,.12);color:#065f46}

  /* Balances & Totals */
  #balances, #totals { display:grid; gap:10px; }
  .mini{border:1px solid var(--muted);border-radius:12px;padding:12px;box-shadow:0 4px 6px rgba(0,0,0,0.02);}
  .mini h4{margin:0 0 8px;font-size:16px;color:var(--brand)}
  .line{display:flex;justify-content:space-between;padding:4px 0;font-size:14px}
  .amt-pos{color:#22c55e;font-weight:700} .amt-neg{color:#ef4444;font-weight:700}
  
  .danger{color:#ef4444;border-color:#ef4444;color:#fff;background:#ef4444}
  </style>
</head>
<body>
  <div class="container">
    <div class="app">
      <div class="title">Group Expense Tracker</div>

      <div id="login-screen">
        <p style="color:var(--sub);margin-bottom:20px;">Select your name and enter your PIN</p>
        <select id="loginName">
          <option value="tayyab">Tayyab</option>
          <option value="islam">Islam</option>
          <option value="mahmur">Mahmur</option>
          <option value="guest">Guest</option>
        </select>
        <input id="loginPin" type="tel" maxlength="6" placeholder="******" />
        <button id="loginBtn" class="primary">Unlock App</button>
        <p id="loginError" style="color:red;font-size:13px;display:none;margin-top:10px;">Incorrect PIN</p>
      </div>

      <div id="main-app" style="display:none">
        <div style="text-align:center;margin-bottom:15px;">
           <span id="user-greeting" style="font-weight:bold;color:var(--brand)"></span>
           <button id="logoutBtn" style="width:auto;padding:4px 12px;font-size:12px;margin-left:10px;" class="ghost">Lock App üîí</button>
        </div>

        <div class="tabs">
          <button class="tab active" data-tab="add">üí∏ Add Expense</button>
          <button class="tab" data-tab="pay">ü§ù Pay Back</button>
          <button class="tab" data-tab="history">üìú History</button>
        </div>

        <div id="tab-add" class="tabview">
          <div class="grid">
            <div class="card">
              <h3>Add Expense</h3>
              <div class="row"><input id="amount" type="number" step="0.01" placeholder="Amount"/></div>
              <div class="row"><select id="paidBy"></select></div>
              <div class="row"><input id="desc" placeholder="Description"/></div>
              <div style="font-size:12px;color:var(--sub);margin-bottom:4px">Split Between:</div>
              <div id="splitBetween" class="pillbar"></div>
              <div class="row"><button id="addBtn" class="primary">Add Expense</button></div>
            </div>
            <div class="card"><h3>Balances</h3><div id="balances"></div></div>
          </div>
        </div>

        <div id="tab-pay" class="tabview" style="display:none">
          <div class="grid">
            <div class="card">
              <h3>Record Payment</h3>
              <div class="row"><input id="payAmount" type="number" step="0.01" placeholder="Amount"/></div>
              <div class="row"><select id="from"></select></div>
              <div class="row"><select id="to"></select></div>
              <div class="row"><button id="payBtn" class="primary">Record Payment</button></div>
            </div>
            <div class="card"><h3>Totals</h3><div id="totals"></div></div>
          </div>
        </div>

        <div id="tab-history" class="tabview" style="display:none">
          <div class="card">
            <h3>History</h3>
            <div style="overflow-x:auto"><table id="historyTable"><thead><tr><th>Date</th><th>Desc</th><th class="right">Amt</th><th>Who</th><th>Split/To</th><th></th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>
      </div>

    </div>
  </div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js';

  // CONFIGURATION
  const firebaseConfig = {
    apiKey: "AIzaSyDwP_AusU7Rar2aguy0DVGGlravF9q2D1g",
    authDomain: "house-expenditure-calculator.firebaseapp.com",
    projectId: "house-expenditure-calculator",
    storageBucket: "house-expenditure-calculator.firebasestorage.app",
    messagingSenderId: "209030650549",
    appId: "1:209030650549:web:de2eae21574b9023f1bcfc",
    measurementId: "G-0HV7FPY7ME"
  };

  const PEOPLE = ['Tayyab','Islam','Mahmur','Guest'];
  const CURRENCY = '‚Ç∫';

  // INIT
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const txCol = collection(db, 'transactions');
  
  // DOM ELEMENTS
  const $ = s => document.querySelector(s);
  const el = (t,c,h)=>{const e=document.createElement(t);if(c)e.className=c;if(h)e.innerHTML=h;return e};

  // --- AUTHENTICATION LOGIC ---
  
  $('#loginBtn').onclick = () => {
    const name = $('#loginName').value;
    const pin = $('#loginPin').value;
    const email = `${name}@group.app`; // Trick: Convert Name+PIN to Email+Password
    
    signInWithEmailAndPassword(auth, email, pin)
      .catch(e => {
        $('#loginError').style.display = 'block';
        console.error(e);
      });
  };

  $('#logoutBtn').onclick = () => signOut(auth);

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // User Logged In
      $('#login-screen').style.display = 'none';
      $('#main-app').style.display = 'block';
      const name = user.email.split('@')[0];
      $('#user-greeting').textContent = `Hi, ${name.charAt(0).toUpperCase() + name.slice(1)}`;
      $('#loginPin').value = ''; 
      startApp(); // Load the data
    } else {
      // User Logged Out
      $('#login-screen').style.display = 'block';
      $('#main-app').style.display = 'none';
      $('#historyTable tbody').innerHTML = ''; // Hide data
      $('#balances').innerHTML = '';
      if(unsubscribe) unsubscribe(); // Stop listening to database
    }
  });

  // --- APP LOGIC ---

  let unsubscribe; // To stop updates when logged out

  function startApp() {
    // Render Dropdowns
    $('#paidBy').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    $('#from').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    $('#to').innerHTML = PEOPLE.map(p=>`<option value="${p}">${p}</option>`).join('');
    
    $('#splitBetween').innerHTML = '';
    PEOPLE.forEach(p => {
       const b = el('button','pill',p);
       b.onclick = ()=>b.classList.toggle('active');
       $('#splitBetween').appendChild(b);
    });

    // Listen to Database
    if(unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(query(txCol, orderBy('createdAt','desc')), (snap) => {
      const txs = [];
      snap.forEach(d => txs.push({id:d.id, ...d.data()}));
      renderHistory(txs);
      calculateBalances(txs);
    }, (err) => {
      alert("Error: You probably don't have permission. Did you log in?");
    });
  }

  // Add Expense
  $('#addBtn').onclick = async () => {
    const amt = parseFloat($('#amount').value);
    const who = $('#paidBy').value;
    const desc = $('#desc').value;
    const split = Array.from(document.querySelectorAll('#splitBetween .pill.active')).map(b=>b.textContent);
    
    if(!amt || !who || split.length===0) return alert('Fill amount, payer and split');
    
    try {
      await addDoc(txCol, {type:'Expense', amount:amt, paidBy:who, splitBetween:split, description:desc, date:new Date().toISOString(), createdAt:serverTimestamp()});
      $('#amount').value=''; $('#desc').value=''; 
      document.querySelectorAll('.pill.active').forEach(b=>b.classList.remove('active'));
    } catch(e) { alert('Permission Denied'); }
  };

  // Add Payment
  $('#payBtn').onclick = async () => {
    const amt = parseFloat($('#payAmount').value);
    const f = $('#from').value; const t = $('#to').value;
    if(!amt || f===t) return alert('Check details');
    try {
      await addDoc(txCol, {type:'Payment', amount:amt, from:f, to:t, date:new Date().toISOString(), createdAt:serverTimestamp()});
      $('#payAmount').value='';
    } catch(e) { alert('Permission Denied'); }
  };

  // Render History
  function renderHistory(txs) {
    const tbody = $('#historyTable tbody'); tbody.innerHTML = '';
    
    tbody.onclick = async (e) => {
       if(e.target.classList.contains('danger')) {
         if(confirm('Delete?')) {
            try { await deleteDoc(doc(db,'transactions',e.target.dataset.id)); }
            catch(err){ alert('Permission Denied'); }
         }
       }
    };

    txs.forEach(t => {
       const d = t.date ? t.date.slice(0,10) : '';
       const isExp = t.type === 'Expense';
       const desc = t.description || (isExp ? 'Expense' : 'Payment');
       const who = isExp ? t.paidBy : `${t.from} ‚Üí ${t.to}`;
       const split = isExp ? (t.splitBetween||[]).join(', ') : '-';
       const tr = el('tr','',`<td>${d}</td><td>${desc}</td><td class="right">${CURRENCY}${t.amount}</td><td>${who}</td><td>${split}</td><td><button class="badge danger" data-id="${t.id}">X</button></td>`);
       tbody.appendChild(tr);
    });
  }

  // Calculate Balances (Simplified for display)
  function calculateBalances(txs) {
     const idx = Object.fromEntries(PEOPLE.map((p,i)=>[p,i]));
     const owes = Array.from({length:4},()=>Array(4).fill(0)); // 4x4 matrix
     
     // 1. Process all transactions
     txs.reverse().forEach(t => {
        if(t.type==='Expense') {
           const inc = (t.splitBetween||[]).filter(x=>PEOPLE.includes(x));
           if(!inc.length) return;
           const payerI = idx[t.paidBy];
           const share = t.amount / inc.length;
           inc.forEach(name => {
              const owerI = idx[name];
              if(owerI !== payerI) owes[owerI][payerI] += share;
           });
        } else { // Payment
           const f = idx[t.from], to = idx[t.to];
           if(f!=null && to!=null) owes[f][to] -= t.amount;
        }
     });

     // 2. Render Cards
     const box = $('#balances'); box.innerHTML = '';
     PEOPLE.forEach((p, i) => {
        const card = el('div','mini',`<h4>${p}</h4>`);
        PEOPLE.forEach((other, j) => {
           if(i===j) return;
           const net = owes[i][j] - owes[j][i]; // positive = i owes j
           if(Math.abs(net) > 0.1) {
              const color = net > 0 ? 'amt-neg' : 'amt-pos';
              const text = net > 0 ? `Owes ${other}` : `${other} owes me`;
              card.appendChild(el('div','line',`${text} <span class="${color}">${CURRENCY}${Math.abs(net).toFixed(2)}</span>`));
           }
        });
        box.appendChild(card);
     });
     
     // Totals (Simplified)
     const totBox = $('#totals'); totBox.innerHTML = '';
     // (Re-using similar logic as your original code for totals could go here if needed, keeping it simple for now)
  }

  // Tabs
  document.querySelectorAll('.tab').forEach(b => b.onclick = () => {
     document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
     b.classList.add('active');
     document.querySelectorAll('.tabview').forEach(v=>v.style.display='none');
     $('#tab-'+b.dataset.tab).style.display='block';
  });

</script>
</body>
</html>
